<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat with Your Twin - EchoMe X</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/pages.css">
    <link rel="stylesheet" href="css/utilities.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
</head>
<body>
    <div class="page-wrapper">
        <!-- Header -->
        <header class="header">
            <nav class="navbar">
                <div class="nav-container">
                    <div class="nav-brand">
                        <a href="index.html" class="nav-logo">
                            <div class="logo-icon">
                                <svg viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M12 2L2 7V10C2 16 6 20.5 12 22C18 20.5 22 16 22 10V7L12 2Z"/>
                                </svg>
                            </div>
                            <span class="logo-text">EchoMe X</span>
                        </a>
                    </div>
                    
                    <ul class="nav-menu">
                        <li><a href="index.html" class="nav-link">Home</a></li>
                        <li><a href="chat.html" class="nav-link active">Chat</a></li>
                        <li><a href="analytics.html" class="nav-link">Analytics</a></li>
                    </ul>
                    
                    <button class="nav-toggle d-md-block d-none">
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                        <span class="hamburger-line"></span>
                    </button>
                </div>
            </nav>
        </header>

        <!-- Chat Interface -->
        <main class="chat-page">
            <div class="chat-container">
                <!-- Chat Header -->
                <div class="chat-header">
                    <div class="chat-twin-info">
                        <div class="twin-avatar" id="twinAvatar">
                            <span id="twinInitial">A</span>
                        </div>
                        <div class="twin-details">
                            <h3 class="chat-twin-name" id="twinName">AI Twin</h3>
                            <span class="chat-twin-status">Online</span>
                        </div>
                    </div>
                    
                    <div class="chat-controls d-md-none">
                        <button class="control-btn" title="Settings">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                            </svg>
                        </button>
                        <button class="control-btn" title="Clear Chat" id="clearChat">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M19,4H15.5L14.5,3H9.5L8.5,4H5V6H19M6,19A2,2 0 0,0 8,21H16A2,2 0 0,0 18,19V7H6V19Z"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Messages Area -->
                <div class="chat-messages" id="chatMessages">
                    <!-- Welcome Message -->
                    <div class="welcome-message" id="welcomeMessage">
                        <div class="welcome-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 2L2 7V10C2 16 6 20.5 12 22C18 20.5 22 16 22 10V7L12 2Z"/>
                            </svg>
                        </div>
                        <h2 class="welcome-title">Chat with Your AI Twin</h2>
                        <p class="welcome-text">
                            Start a conversation with your AI twin. Ask questions, share thoughts, or just have a casual chat!
                        </p>
                    </div>
                </div>

                <!-- Typing Indicator -->
                <div class="typing-indicator d-none" id="typingIndicator">
                    <div class="message-content">
                        <div class="message-avatar">
                            <span id="typingAvatar">A</span>
                        </div>
                        <div class="typing-content">
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                            <div class="typing-dot"></div>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <form class="chat-input-form" id="chatForm">
                            <textarea 
                                class="chat-input" 
                                id="messageInput" 
                                placeholder="Type your message..."
                                rows="1"
                                maxlength="1000"
                            ></textarea>
                            
                            <div class="input-actions">
                                <button type="button" class="attach-btn" title="Attach file">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M16.5 6V17.5A4 4 0 0 1 12.5 21.5A4 4 0 0 1 8.5 17.5V5A2.5 2.5 0 0 1 11 2.5A2.5 2.5 0 0 1 13.5 5V15.5A1 1 0 0 1 12.5 16.5A1 1 0 0 1 11.5 15.5V6H10V15.5A2.5 2.5 0 0 0 12.5 18A2.5 2.5 0 0 0 15 15.5V5A4 4 0 0 0 11 1A4 4 0 0 0 7 5V17.5A5.5 5.5 0 0 0 12.5 23A5.5 5.5 0 0 0 18 17.5V6H16.5Z"/>
                                    </svg>
                                </button>
                                
                                <button type="submit" class="send-btn" id="sendBtn" disabled>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                                    </svg>
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <div class="toast-content">
            <div class="toast-icon" id="toastIcon"></div>
            <div class="toast-message">
                <div class="toast-title" id="toastTitle"></div>
                <div class="toast-description" id="toastDescription"></div>
            </div>
            <button class="toast-close" id="toastClose">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z"/>
                </svg>
            </button>
        </div>
    </div>

    <script src="utils.js"></script>
    <script src="js/api.js"></script>
    <script src="chat.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', async function() {
  let currentTwin = null;
  
  // Get current twin info
  try {
    console.log('üîÑ Loading twin info for chat...');
    const twinInfo = await window.echoAPI.getTwinInfo();
    console.log('Current twin:', twinInfo);
    
    if (twinInfo.success) {
      currentTwin = twinInfo.data;
      
      // Update chat interface with twin name
      const twinNameElement = document.getElementById('twinName');
      const twinInitialElement = document.getElementById('twinInitial');
      const typingAvatarElement = document.getElementById('typingAvatar');
      
      if (twinNameElement) {
        twinNameElement.textContent = currentTwin.name;
      }
      
      if (twinInitialElement && typingAvatarElement) {
        const initial = currentTwin.name.charAt(0).toUpperCase();
        twinInitialElement.textContent = initial;
        typingAvatarElement.textContent = initial;
      }
      
      // Update welcome message
      const welcomeTitle = document.querySelector('.welcome-title');
      if (welcomeTitle) {
        welcomeTitle.textContent = `Chat with ${currentTwin.name}`;
      }
      
      console.log('‚úÖ Chat interface updated with twin info');
    } else {
      throw new Error('No twin data received');
    }
  } catch (error) {
    console.log('‚ùå No twin found, showing create twin message');
    showCreateTwinMessage();
  }
  
  // Handle chat form submission
  const chatForm = document.getElementById('chatForm');
  const messageInput = document.getElementById('messageInput');
  const sendBtn = document.getElementById('sendBtn');
  const chatMessages = document.getElementById('chatMessages');
  
  // Enable/disable send button based on input
  messageInput.addEventListener('input', function() {
    const hasText = this.value.trim().length > 0;
    sendBtn.disabled = !hasText;
    sendBtn.style.opacity = hasText ? '1' : '0.5';
  });
  
  // Handle form submission
  chatForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const message = messageInput.value.trim();
    if (!message || !currentTwin) return;
    
    // Add user message to chat
    addMessageToChat('user', message);
    
    // Clear input and disable send button
    messageInput.value = '';
    sendBtn.disabled = true;
    sendBtn.style.opacity = '0.5';
    
    // Show typing indicator
    showTypingIndicator();
    
    try {
      console.log('üì§ Sending message to twin:', message);
      
      // Send message to backend
      const response = await window.echoAPI.sendMessage(message, currentTwin.name);
      
      if (response.success) {
        // Add AI response to chat
        addMessageToChat('ai', response.data.message);
        console.log('‚úÖ AI response received');
      } else {
        throw new Error('Failed to get response');
      }
    } catch (error) {
      console.error('‚ùå Chat error:', error);
      addMessageToChat('ai', "I'm having trouble responding right now. Please try again!");
    } finally {
      hideTypingIndicator();
    }
  });
  
  // Auto-resize textarea
  messageInput.addEventListener('input', function() {
    this.style.height = 'auto';
    this.style.height = this.scrollHeight + 'px';
  });
});

// Function to add messages to chat
function addMessageToChat(type, message) {
  const chatMessages = document.getElementById('chatMessages');
  const welcomeMessage = document.getElementById('welcomeMessage');
  
  // Hide welcome message on first message
  if (welcomeMessage) {
    welcomeMessage.style.display = 'none';
  }
  
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${type}-message animate-fade-in`;
  
  const currentTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  
  if (type === 'user') {
    messageDiv.innerHTML = `
      <div class="message-content">
        <div class="message-text">${escapeHtml(message)}</div>
        <div class="message-time">${currentTime}</div>
      </div>
    `;
  } else {
    const twinInitial = document.getElementById('twinInitial')?.textContent || 'A';
    messageDiv.innerHTML = `
      <div class="message-content">
        <div class="message-avatar">
          <span>${twinInitial}</span>
        </div>
        <div class="message-bubble">
          <div class="message-text">${escapeHtml(message)}</div>
          <div class="message-time">${currentTime}</div>
        </div>
      </div>
    `;
  }
  
  chatMessages.appendChild(messageDiv);
  chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Function to show typing indicator
function showTypingIndicator() {
  const typingIndicator = document.getElementById('typingIndicator');
  if (typingIndicator) {
    typingIndicator.classList.remove('d-none');
    
    // Scroll to bottom
    const chatMessages = document.getElementById('chatMessages');
    setTimeout(() => {
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }, 100);
  }
}

// Function to hide typing indicator
function hideTypingIndicator() {
  const typingIndicator = document.getElementById('typingIndicator');
  if (typingIndicator) {
    typingIndicator.classList.add('d-none');
  }
}

// Function to show create twin message
function showCreateTwinMessage() {
  const chatMessages = document.getElementById('chatMessages');
  chatMessages.innerHTML = `
    <div class="welcome-message">
      <div class="welcome-icon">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2L2 7V10C2 16 6 20.5 12 22C18 20.5 22 16 22 10V7L12 2Z"/>
        </svg>
      </div>
      <h2 class="welcome-title">No Twin Found</h2>
      <p class="welcome-text">
        You need to create an AI twin first before you can chat!
      </p>
      <a href="index.html" class="btn btn-primary" style="margin-top: 1rem;">
        Create Your Twin
      </a>
    </div>
  `;
}

// Helper function to escape HTML
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
</body>
</html>